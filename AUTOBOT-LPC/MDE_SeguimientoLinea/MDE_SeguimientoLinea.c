/*******************************************************************************************************************************//**
 *
 * @file		MDE_SeguimientoLinea.c
 * @brief		Modulo para el manejo wifi
 * @date		25/02/21
 * @author		Andres Yang, Luis Gindre, Uriel Mayo
 **********************************************************************************************************************************/

/*********************************************************************************************************************************
 *** INCLUDES
**********************************************************************************************************************************/
#include "MDE_SeguimientoLinea.h"
#include "PR_motor.h"
#include "Flags.h"
#include "esp8266.h"

#include "DR_sensorInfrarojo.h"
/*********************************************************************************************************************************
 *** DEFINES PRIVADOS AL MODULO
**********************************************************************************************************************************/

/*********************************************************************************************************************************
 *** MACROS PRIVADAS AL MODULO
**********************************************************************************************************************************/

/*********************************************************************************************************************************
 *** TIPOS DE DATOS PRIVADOS AL MODULO
**********************************************************************************************************************************/

/*********************************************************************************************************************************
 *** TABLAS PRIVADAS AL MODULO
**********************************************************************************************************************************/

/*********************************************************************************************************************************
 *** VARIABLES GLOBALES PUBLICAS
**********************************************************************************************************************************/
/*********************************************************************************************************************************
 *** VARIABLES GLOBALES PRIVADAS AL MODULO
**********************************************************************************************************************************/

/*********************************************************************************************************************************
 *** PROTOTIPO DE FUNCIONES PRIVADAS AL MODULO
**********************************************************************************************************************************/

/*********************************************************************************************************************************
 *** FUNCIONES PRIVADAS AL MODULO
**********************************************************************************************************************************/

/*********************************************************************************************************************************
 *** FUNCIONES GLOBALES AL MODULO
**********************************************************************************************************************************/
void maquina_MdESeguimientoLinea()
{
	static int estado = ONLINE;

	if(cnyFlg){
		sensorInfrarojo_update();
		cnyFlg = 0;
	}

	switch(estado){
	case ONLINE:
		avanzar();

		if(!SensorCentralActivado()){
			motor_stop();
			rideStatus = FINISHED;
		}
		else if(SensorLineaDerActivado()){ //Desvio derecha
			estado = DESVIO_DERECHA;
		}
		else if(SensorLineaIzqActivado()){ // desvio izquierda
			estado = DESVIO_IZQUIERDA;
		}

		checkearPerdido();
		break;
	case DESVIO_DERECHA:
		if(!SensorLineaDerActivado()){
			estado = ONLINE;
		}
		else girarIzq(CORRECTION);

		checkearPerdido();
		break;
	case DESVIO_IZQUIERDA:
		if(!SensorLineaIzqActivado()){
			estado = ONLINE;
		}
		else girarDer(CORRECTION);

		checkearPerdido();
		break;
	default: estado = ONLINE;
		break;
	}
}

/***********************************************************************************************************************************
 *** FIN DEL MODULO
 **********************************************************************************************************************************/

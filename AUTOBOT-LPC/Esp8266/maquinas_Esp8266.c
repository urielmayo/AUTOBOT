/*******************************************************************************************************************************//**
 *
 * @file		maquinas_Esp8266.c
 * @brief		maquinas de estados para manejo de wifi y comunicacion
 * @date		25/02/21
 * @author		Uriel Mayo
 *
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/
#include "esp8266.h"
#include "Flags.h"

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES
 **********************************************************************************************************************************/
uint8_t wifiConnected_flag = 0;

/***********************************************************************************************************************************
 *** PROTOTIPOS DE FUNCIONES
 **********************************************************************************************************************************/
void mdeWifi()
{
	static uint8_t estado = CONFIG_INIT;

	switch (estado) {
	case CONFIG_INIT:		//layer modulo wifi
		if(wifiInit()){
			estado = CONNECT;
		}
		break;

	case CONNECT:		//layer para conectarme al wifi
		if(wifiConnect()){
			estado = SOCKET_CONNECTION;
		}
		break;

	case SOCKET_CONNECTION:		//layer para establecer conexion con Qt
		if(socketConnect()){
			connectionSocketFlg = CONNECTED;
		}
		break;
	default:
		break;
	}
}

void mdeComunication()
{
	static uint8_t estado = RECIBIR, status;

	switch (estado) {
	case ENVIAR:
		if(enviarTrama(status) == EXITO){
			estado = RECIBIR;
		}
		break;
	case RECIBIR:
		status = procesarTrama();
		if(status != WF_PROCESSING){
			estado = ENVIAR;
		}
		break;
	default:
		break;
	}
}

/***********************************************************************************************************************************
 *** FIN DEL MODULO
 **********************************************************************************************************************************/
